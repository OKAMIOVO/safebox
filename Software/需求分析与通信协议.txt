主系统与备用系统
主系统：主控制板，简称主板1；指纹触摸按键板，简称按键板1
备用系统：备用控制板，简称主板2，机械按键板，简称按键板2

需要定制的通信协议
1.主板与按键板（触摸板也属于按键板），两套系统共用同一份协议
2.主系统与备用系统协议



唤醒关系
1.按键板可以唤醒主板
2.主系统可以唤醒备用系统
直接通过发送串口信息唤醒对应的板，然后收到回复再发送下一帧数据，启用超时重发，因为第一帧数据的第一位会产生电平变化，从而唤醒，但是会丢失数据，超时重发即可

休眠：
按键板在一定时间接收不到主板信息，且没有按键，指纹等信息时，休眠
主板在一定时间接收不到按键板信息，另外一套系统的信息，且电机运转完成后，休眠

UART 1 8 1
9600 BAUD
格式：
头，0xaa,
长度，1个字节，数据部分字节个数，最大不超过20
命令，
数据，
校验，除头尾校验位外所有字节异或校验
尾,0xbb

所有通信协议都采用以上格式，且收到以后都要回复相同的命令码
主板->按键板 命令码 在 0x00~0x7f之间
按键板->主板 命令码 在 0x80~0xff之间

主系统->备用系统 命令码 在 0x00~0x7f之间
备用系统->主系统 命令码 在 0x80~0xff之间

两主板之间通信协议

密码传输 
主系统->备用系统
命令码 0x50 
数据 第一字节为密码长度，之后为密码部分，若密码长度为0，则清除密码。主板2收到以后回复完全相同的内容
例：AA 07 50 06 01 02 03 04 05 06 56 BB 密码为123456，主板2收到以后回复完全相同的内容，主板1在确认主板2接收密码无误后，发送下一帧需要发送的数据
AA 01 50 00 51 BB 







主板与按键板通信协议

键值事件上报
按键板->主板
命令码 0x90
数据 固定2字节 1事件：按下或释放；键值：0~11位






按键板2需求分析

1.串口
超时重发，
超时检测且记录状态
2.按键事件检测，通过串口上报
3.休眠唤醒








































备注：
目前是专门发送外部中断检测到被唤醒的板高电平后再开始发送数据，更好的方式是
但是备用系统不用能唤醒主系统，具体的通信协议暂时先只有一条，即主系统给备用系统发送密码，备用系统接收后回复，然后保存密码

主系统注册密码完成时通知备用系统密码,以便备用系统可以在主系统出问题时独立开锁，另外两快控制板需要协调电机操作，不能一个正在开锁，另一个正在关锁，两个电机的协议工作暂时不清楚，先不管

旧内容：
主系统与备用系统之间只有电机控制板有串口通信，串口的两个IO口要复用休眠唤醒功能，只需要主控制板能唤醒备用控制板

备用控制板在一定时间收不到主系统数据后，自行进入休眠

在休眠时，收到主控制板来的外部中断以后，唤醒，并拉高备用控制板的TX线，告知主控制板，备用控制板已唤醒。

备用系统内部 分控制板与按键板，按键板能唤醒控制板，以同样的方式休眠唤醒

按键板需要上报键值，以便通过密码开锁，定时上报，只报不收

格式：头0X5A，键值（2),检验，尾0xA5，通道0，1，2，3……11，对应一个双字节的0~11位，“1”代表按下，“0”代表松开，小端模式，低字节在前，高字节在后

机械按键板上电时默认备用控制板处于休眠状态，持续发送上升沿外部中断，如果检测到控制板的高电平，表示控制板已经唤醒，则初始化串口与按键IO口，开始检测并上报键值，持续一定时间没有键按下以后，进入休眠

控制板上电，默认按键板与主控制板处于唤醒状态，初始化串口（会自动拉高TX脚），一定时间收不到串口数据以后，更改对应板的状态，打开外部中断。

唤醒以后，在外部中断服务程序中更改对应板状态，初始化对应串口，准备接收

在判断按键板和主控制板都处于休眠状态后，进入休眠



